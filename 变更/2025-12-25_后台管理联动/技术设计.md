# 技术设计

## 背景与约束

- 客户端为 Tauri（Rust），本地配置存 SQLite + settings.json，切换供应商会写 Live 配置文件。
- 必须支持离线运行，联网后仅在北京时间 04:00 定时同步。
- 管理端下发必须静默覆盖，冲突以管理端为准。
- 不做账号体系与审计日志。

## 目标

- 建立管理端 API 与数据库，记录设备与配置。
- 提供管理端 Web UI（设备列表、配置查看、批量下发）。
- 客户端按日定时上报配置并接收管理端配置。
- 服务端通过 IP 识别地区，满足跨分公司/出差定位需求。

## 不做（Non-Goals）

- 不支持实时推送与即时同步（仍按每日 04:00 拉取）。
- 不做用户账号体系与审计日志。

## 技术决策

| 决策点 | 选择 | 原因 | 放弃的方案 |
|--------|------|------|-----------|
| 服务端技术栈 | Rust + Axum + PostgreSQL | 现有团队已使用 Rust，复用生态与部署方式 | Node/Go（引入新运行时与运维链路） |
| 管理端 UI | React + Vite | 交付效率高，易于扩展与部署 | 服务端模板渲染（交互能力受限） |
| IP 识别 | MaxMind GeoIP2/GeoLite2 本地库 | 不依赖外部 API，公网稳定性可控 | 第三方 IP API（外部依赖与可用性风险） |
| 设备标识 | machine-uid 获取硬件指纹并哈希 | 跨平台、稳定、无需用户登录 | 随机 UUID（不满足“硬件指纹”要求） |
| 冲突策略 | 管理端权威（Server-authoritative） | 满足静默下发覆盖需求 | 客户端优先/CRDT（复杂度高） |
| 访问控制 | Sync Token + Admin Token/Basic Auth | 无账号体系下最小可行安全控制 | 完全无鉴权（不满足安全诉求） |

## 架构差异/一致性评估

- 新增 `server/` 与现有 `src-tauri/` 解耦，客户端仅通过 HTTPS 调用 API。
- 客户端新增同步服务放置在 `src-tauri/src/services/`，遵循现有 service 分层。
- 不改动现有 Provider/DB 结构，仅新增同步模块与 settings 键值。
- 管理端 UI 与 API 同域部署，避免跨域复杂度。

## 风险与缓解

| 风险 | 缓解措施 |
|------|----------|
| IP 识别误差 | 仅用于地域归类，不作为安全策略；可定期更新 GeoIP 库 |
| 硬件指纹获取失败 | 记录错误并跳过同步，避免生成伪 ID |
| 管理端覆盖误配置 | 保存客户端快照，便于回溯对比 |
| 公网暴露风险 | HTTPS + Token 校验 + 日志最小化 |

## 迁移/回滚方案

- **迁移步骤**：
  1) 部署 server 与数据库；2) 配置 GeoIP 数据库；3) 部署管理端 UI；4) 发布新客户端。
- **回滚步骤**：
  1) 停用客户端同步开关（环境变量）；2) 停止 server。
- **验证方式**：
  - 离线可用、04:00 同步触发、管理端下发覆盖生效。

## 假设与配置约定

- 客户端通过环境变量提供管理端地址与 Token（如 `AI_CODE_WITH_MANAGEMENT_URL`、`AI_CODE_WITH_SYNC_TOKEN`）。
- 服务端通过环境变量配置数据库与 Token。
- UI 访问默认路径 `/admin`（可由反向代理调整）。
